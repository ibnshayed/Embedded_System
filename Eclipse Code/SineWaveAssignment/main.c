/*
 * main.c
 *
 *  Created on: Aug 30, 2019
 *      Author: ibnshayed
 */

/**
 *  @name 13-bit Sine and Cosine wave generator
 *  @author Tanvir Ahmed
 *  @details Sine and Cosine wave generation using PWM
 */
#include<avr/io.h>
#include<util/delay.h>

#define MX 8192 //!< 13-bit range
#define SIZE 512 //!< Number of data points for each plot (sine, cosine)

//!< Both sine and cosine arrays hold 512 16-bit data points each, the curves are generated by iterating through them.
uint16_t sine[] = { 4095, 4145, 4196, 4246, 4296, 4346, 4396, 4446, 4496, 4546,
		4596, 4646, 4696, 4746, 4795, 4845, 4894, 4943, 4992, 5041, 5090, 5139,
		5187, 5236, 5284, 5332, 5380, 5427, 5475, 5522, 5569, 5616, 5662, 5709,
		5755, 5800, 5846, 5891, 5936, 5981, 6026, 6070, 6114, 6157, 6201, 6243,
		6286, 6328, 6370, 6412, 6453, 6494, 6535, 6575, 6615, 6654, 6693, 6732,
		6770, 6808, 6845, 6882, 6919, 6955, 6991, 7026, 7061, 7096, 7130, 7163,
		7196, 7229, 7261, 7293, 7324, 7354, 7385, 7414, 7443, 7472, 7500, 7528,
		7555, 7582, 7608, 7633, 7658, 7683, 7707, 7730, 7753, 7776, 7797, 7818,
		7839, 7859, 7879, 7898, 7916, 7934, 7951, 7968, 7984, 7999, 8014, 8028,
		8042, 8055, 8068, 8080, 8091, 8102, 8112, 8121, 8130, 8138, 8146, 8153,
		8160, 8166, 8171, 8175, 8179, 8183, 8186, 8188, 8189, 8190, 8191, 8190,
		8189, 8188, 8186, 8183, 8179, 8175, 8171, 8166, 8160, 8153, 8146, 8138,
		8130, 8121, 8112, 8102, 8091, 8080, 8068, 8055, 8042, 8028, 8014, 7999,
		7984, 7968, 7951, 7934, 7916, 7898, 7879, 7859, 7839, 7818, 7797, 7776,
		7753, 7730, 7707, 7683, 7658, 7633, 7608, 7582, 7555, 7528, 7500, 7472,
		7443, 7414, 7385, 7354, 7324, 7293, 7261, 7229, 7196, 7163, 7130, 7096,
		7061, 7026, 6991, 6955, 6919, 6882, 6845, 6808, 6770, 6732, 6693, 6654,
		6615, 6575, 6535, 6494, 6453, 6412, 6370, 6328, 6286, 6243, 6201, 6157,
		6114, 6070, 6026, 5981, 5936, 5891, 5846, 5800, 5755, 5709, 5662, 5616,
		5569, 5522, 5475, 5427, 5380, 5332, 5284, 5236, 5187, 5139, 5090, 5041,
		4992, 4943, 4894, 4845, 4795, 4746, 4696, 4646, 4596, 4546, 4496, 4446,
		4396, 4346, 4296, 4246, 4196, 4145, 4095, 4045, 3994, 3944, 3894, 3844,
		3794, 3744, 3694, 3644, 3594, 3544, 3494, 3444, 3395, 3345, 3296, 3247,
		3198, 3149, 3100, 3051, 3003, 2954, 2906, 2858, 2810, 2763, 2715, 2668,
		2621, 2574, 2528, 2481, 2435, 2390, 2344, 2299, 2254, 2209, 2164, 2120,
		2076, 2033, 1989, 1947, 1904, 1862, 1820, 1778, 1737, 1696, 1655, 1615,
		1575, 1536, 1497, 1458, 1420, 1382, 1345, 1308, 1271, 1235, 1199, 1164,
		1129, 1094, 1060, 1027, 994, 961, 929, 897, 866, 836, 805, 776, 747,
		718, 690, 662, 635, 608, 582, 557, 532, 507, 483, 460, 437, 414, 393,
		372, 351, 331, 311, 292, 274, 256, 239, 222, 206, 191, 176, 162, 148,
		135, 122, 110, 99, 88, 78, 69, 60, 52, 44, 37, 30, 24, 19, 15, 11, 7, 4,
		2, 1, 0, 0, 0, 1, 2, 4, 7, 11, 15, 19, 24, 30, 37, 44, 52, 60, 69, 78,
		88, 99, 110, 122, 135, 148, 162, 176, 191, 206, 222, 239, 256, 274, 292,
		311, 331, 351, 372, 393, 414, 437, 460, 483, 507, 532, 557, 582, 608,
		635, 662, 690, 718, 747, 776, 805, 836, 866, 897, 929, 961, 994, 1027,
		1060, 1094, 1129, 1164, 1199, 1235, 1271, 1308, 1345, 1382, 1420, 1458,
		1497, 1536, 1575, 1615, 1655, 1696, 1737, 1778, 1820, 1862, 1904, 1947,
		1989, 2033, 2076, 2120, 2164, 2209, 2254, 2299, 2344, 2390, 2435, 2481,
		2528, 2574, 2621, 2668, 2715, 2763, 2810, 2858, 2906, 2954, 3003, 3051,
		3100, 3149, 3198, 3247, 3296, 3345, 3395, 3444, 3494, 3544, 3594, 3644,
		3694, 3744, 3794, 3844, 3894, 3944, 3994, 4045 };

uint16_t cosine[] = { 8191, 8190, 8189, 8188, 8186, 8183, 8179, 8175, 8171,
		8166, 8160, 8153, 8146, 8138, 8130, 8121, 8112, 8102, 8091, 8080, 8068,
		8055, 8042, 8028, 8014, 7999, 7984, 7968, 7951, 7934, 7916, 7898, 7879,
		7859, 7839, 7818, 7797, 7776, 7753, 7730, 7707, 7683, 7658, 7633, 7608,
		7582, 7555, 7528, 7500, 7472, 7443, 7414, 7385, 7354, 7324, 7293, 7261,
		7229, 7196, 7163, 7130, 7096, 7061, 7026, 6991, 6955, 6919, 6882, 6845,
		6808, 6770, 6732, 6693, 6654, 6615, 6575, 6535, 6494, 6453, 6412, 6370,
		6328, 6286, 6243, 6201, 6157, 6114, 6070, 6026, 5981, 5936, 5891, 5846,
		5800, 5755, 5709, 5662, 5616, 5569, 5522, 5475, 5427, 5380, 5332, 5284,
		5236, 5187, 5139, 5090, 5041, 4992, 4943, 4894, 4845, 4795, 4746, 4696,
		4646, 4596, 4546, 4496, 4446, 4396, 4346, 4296, 4246, 4196, 4145, 4095,
		4045, 3994, 3944, 3894, 3844, 3794, 3744, 3694, 3644, 3594, 3544, 3494,
		3444, 3395, 3345, 3296, 3247, 3198, 3149, 3100, 3051, 3003, 2954, 2906,
		2858, 2810, 2763, 2715, 2668, 2621, 2574, 2528, 2481, 2435, 2390, 2344,
		2299, 2254, 2209, 2164, 2120, 2076, 2033, 1989, 1947, 1904, 1862, 1820,
		1778, 1737, 1696, 1655, 1615, 1575, 1536, 1497, 1458, 1420, 1382, 1345,
		1308, 1271, 1235, 1199, 1164, 1129, 1094, 1060, 1027, 994, 961, 929,
		897, 866, 836, 805, 776, 747, 718, 690, 662, 635, 608, 582, 557, 532,
		507, 483, 460, 437, 414, 393, 372, 351, 331, 311, 292, 274, 256, 239,
		222, 206, 191, 176, 162, 148, 135, 122, 110, 99, 88, 78, 69, 60, 52, 44,
		37, 30, 24, 19, 15, 11, 7, 4, 2, 1, 0, 0, 0, 1, 2, 4, 7, 11, 15, 19, 24,
		30, 37, 44, 52, 60, 69, 78, 88, 99, 110, 122, 135, 148, 162, 176, 191,
		206, 222, 239, 256, 274, 292, 311, 331, 351, 372, 393, 414, 437, 460,
		483, 507, 532, 557, 582, 608, 635, 662, 690, 718, 747, 776, 805, 836,
		866, 897, 929, 961, 994, 1027, 1060, 1094, 1129, 1164, 1199, 1235, 1271,
		1308, 1345, 1382, 1420, 1458, 1497, 1536, 1575, 1615, 1655, 1696, 1737,
		1778, 1820, 1862, 1904, 1947, 1989, 2033, 2076, 2120, 2164, 2209, 2254,
		2299, 2344, 2390, 2435, 2481, 2528, 2574, 2621, 2668, 2715, 2763, 2810,
		2858, 2906, 2954, 3003, 3051, 3100, 3149, 3198, 3247, 3296, 3345, 3395,
		3444, 3494, 3544, 3594, 3644, 3694, 3744, 3794, 3844, 3894, 3944, 3994,
		4045, 4095, 4145, 4196, 4246, 4296, 4346, 4396, 4446, 4496, 4546, 4596,
		4646, 4696, 4746, 4795, 4845, 4894, 4943, 4992, 5041, 5090, 5139, 5187,
		5236, 5284, 5332, 5380, 5427, 5475, 5522, 5569, 5616, 5662, 5709, 5755,
		5800, 5846, 5891, 5936, 5981, 6026, 6070, 6114, 6157, 6201, 6243, 6286,
		6328, 6370, 6412, 6453, 6494, 6535, 6575, 6615, 6654, 6693, 6732, 6770,
		6808, 6845, 6882, 6919, 6955, 6991, 7026, 7061, 7096, 7130, 7163, 7196,
		7229, 7261, 7293, 7324, 7354, 7385, 7414, 7443, 7472, 7500, 7528, 7555,
		7582, 7608, 7633, 7658, 7683, 7707, 7730, 7753, 7776, 7797, 7818, 7839,
		7859, 7879, 7898, 7916, 7934, 7951, 7968, 7984, 7999, 8014, 8028, 8042,
		8055, 8068, 8080, 8091, 8102, 8112, 8121, 8130, 8138, 8146, 8153, 8160,
		8166, 8171, 8175, 8179, 8183, 8186, 8188, 8189, 8190 };

/**
 * @brief Function to generate sine and cosine wave simultaneously using 2 PWM channel of Timer01
 * @details We used 16-bit data structure to store 13-bit values. sine[] and cosine[] have total of 1024 data points, 100% of the microcontroller memory is consumed, that is why we could not put more 16-bit data points
 *
 */
void generate_wave() {
	while (1) {
		for (int i = 0; i < 512; i++) {
			OCR1A = sine[i];
			OCR1B = cosine[i];
			_delay_ms(2);
		}
	}
}

int main(void) {
	DDRB |= (1 << PB2) | (1 << PB1); //OCR1A and OCR1B as output. We used both

	//Setup variable TOP Fast PWM Mode 14
	// WGM13=1, WGM12=1, WGM11=1, WGM10=0 is for fastPWM in variable TOP mode.
	// Here TOP = ICR1 = 8191 (2^13 - 1)
	// Refer to datasheet pg 136

	OCR1A = 0; // initializing OCR1A
	OCR1B = 0; // initializing OCR1B

	TCCR1B |= (1 << WGM13) | (1 << WGM12); //
	TCCR1A |= (1 << COM1A1) | (0 << COM1A0) | (1 << COM1B1) | (0 << COM1B0)
			| (1 << WGM11) | (0 << WGM10);

	//COM1A1:COM1A0=10 COM1B1:COM1B0=10 and for Clear OC1A/OC1B on Compare Match, set OC1A/OC1B at TOP
	// PWM_Frequency= F_osc / (PreScaler*(1+TOP)) = 16MHz / (1*(1023+1))=  1952.88 = 1.95 KHz
	// Resolution= log(TOP+1)/log(2)= 13 bit

	TCCR1B |= (0 << CS12) | (0 << CS11) | (1 << CS10); //CS12->10 = 001 is for 1:1 timer pre-scaler. Start timer

	ICR1 = 8191; // TOP for our fastPWM

	//generating sine wave through OCR1A and cosine wave through OCR1B
	generate_wave();
}
